# Настройка GitHub Secrets для JWT

## Пошаговая инструкция

### 1. Перейдите в настройки вашего GitHub репозитория

1. Откройте ваш репозиторий на GitHub
2. Нажмите **Settings** (Настройки)
3. В левом меню выберите **Secrets and variables** → **Actions**
4. Нажмите кнопку **New repository secret**

### 2. Добавьте JWT_SECRET

**Этот секрет ОБЯЗАТЕЛЕН для работы системы авторизации!**

1. **Name:** `JWT_SECRET`
2. **Value:** Сгенерируйте сильный случайный ключ минимум 256 бит (32 символа)

#### Как сгенерировать безопасный JWT_SECRET:

**Вариант 1 - С помощью Node.js:**
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

**Вариант 2 - С помощью OpenSSL:**
```bash
openssl rand -base64 32
```

**Вариант 3 - С помощью Python:**
```bash
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

**Вариант 4 - Онлайн генератор:**
- Перейдите на https://www.allkeysgenerator.com/Random/Security-Encryption-Key-Generator.aspx
- Выберите **256-bit** и **Hex**
- Скопируйте сгенерированный ключ

**❗ ВАЖНО:**
- НЕ используйте пример из документации в продакшн!
- Сохраните ключ в надёжном месте (менеджер паролей)
- Один раз установленный ключ НЕ МЕНЯЙТЕ - это сделает все существующие токены недействительными

**Пример сильного ключа:**
```
a7f3d9e2c8b1f4a6d5e8c3b7a9f2e1d4c6b8a5f3e7d2c9b6a4f1e8d3c7b5a2f9
```

3. Нажмите **Add secret**

### 3. Добавьте JWT_EXPIRATION (опционально)

Этот секрет опционален - если не установить, будет использоваться значение по умолчанию (24 часа).

1. **Name:** `JWT_EXPIRATION`
2. **Value:** Время жизни токена в миллисекундах

**Рекомендуемые значения:**
- `3600000` - 1 час (для высокой безопасности)
- `86400000` - 24 часа (рекомендуется, используется по умолчанию)
- `604800000` - 7 дней (для удобства пользователей)

3. Нажмите **Add secret**

### 4. Проверьте существующие секреты

Убедитесь, что у вас также настроены:

✅ **VPS_HOST** - IP адрес или домен вашего VPS
✅ **VPS_USER** - Имя пользователя SSH
✅ **VPS_SSH_KEY** - Приватный SSH ключ
✅ **GIGACHAT_API_TOKEN** - Токен для GigaChat API (если используете)

### 5. Проверка конфигурации

После добавления секретов, ваш список должен выглядеть так:

```
Secrets:
- GIGACHAT_API_TOKEN
- JWT_EXPIRATION (optional)
- JWT_SECRET ✅ REQUIRED
- VPS_HOST
- VPS_SSH_KEY
- VPS_USER
```

## Как работает передача секретов

```
┌─────────────────────────┐
│  GitHub Secrets         │
│  - JWT_SECRET           │
│  - JWT_EXPIRATION       │
│  - GIGACHAT_API_TOKEN   │
└──────────┬──────────────┘
           │
           ▼
┌─────────────────────────┐
│  GitHub Actions         │
│  (.github/workflows/    │
│   deploy.yml)           │
└──────────┬──────────────┘
           │
           ▼
┌─────────────────────────┐
│  SSH to VPS             │
│  Environment variables  │
│  passed via envs param  │
└──────────┬──────────────┘
           │
           ▼
┌─────────────────────────┐
│  deploy.sh              │
│  export JWT_SECRET=...  │
│  export JWT_EXPIRATION  │
└──────────┬──────────────┘
           │
           ▼
┌─────────────────────────┐
│  docker-compose.yml     │
│  environment:           │
│  - JWT_SECRET=${...}    │
└──────────┬──────────────┘
           │
           ▼
┌─────────────────────────┐
│  Spring Boot Container  │
│  application.properties │
│  jwt.secret=${JWT_...}  │
└──────────┬──────────────┘
           │
           ▼
┌─────────────────────────┐
│  JwtTokenProvider       │
│  Uses secrets for       │
│  token generation       │
└─────────────────────────┘
```

## Тестирование после деплоя

### 1. Проверьте логи деплоймента в GitHub Actions

1. Перейдите во вкладку **Actions** в вашем репозитории
2. Найдите последний запуск workflow
3. Проверьте, что нет ошибок связанных с переменными окружения

### 2. Проверьте на VPS

После успешного деплоя, подключитесь к VPS и проверьте:

```bash
# Подключитесь к VPS
ssh your_user@your_vps_ip

# Проверьте, что контейнер запущен
docker ps | grep myapp-backend

# Проверьте логи контейнера
docker logs myapp-backend | tail -50

# Проверьте переменные окружения в контейнере
docker exec myapp-backend env | grep JWT
```

**Ожидаемый вывод:**
```
JWT_SECRET=a7f3d9e2c8b1f4a6d5e8c3b7a9f2e1d4c6b8a5f3e7d2c9b6a4f1e8d3c7b5a2f9
JWT_EXPIRATION=86400000
```

### 3. Проверьте API

Протестируйте регистрацию пользователя:

```bash
curl -X POST http://your_vps_ip:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "firstName": "Test",
    "lastName": "User",
    "email": "test@example.com",
    "password": "password123"
  }'
```

**Успешный ответ должен содержать JWT токен:**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "type": "Bearer",
  "id": 1,
  "email": "test@example.com",
  "firstName": "Test",
  "lastName": "User"
}
```

## Troubleshooting

### ❌ Ошибка: "JWT signature does not match"

**Причина:** JWT_SECRET не установлен или изменился между деплоями

**Решение:**
1. Убедитесь, что `JWT_SECRET` добавлен в GitHub Secrets
2. Проверьте, что секрет имеет правильное имя (чувствительно к регистру)
3. Пере-деплойте приложение

### ❌ Ошибка: "Недействительная JWT подпись"

**Причина:** Используется дефолтный слабый ключ или ключ слишком короткий

**Решение:**
1. Сгенерируйте новый сильный ключ минимум 256 бит
2. Добавьте его в GitHub Secrets
3. Пере-деплойте приложение
4. Все пользователи должны войти заново

### ❌ Контейнер не запускается

**Причина:** Переменные окружения не передаются

**Решение:**
1. Проверьте `.github/workflows/deploy.yml` - секреты должны быть в `env` и `envs`
2. Проверьте `deploy.sh` - должны быть `export` команды
3. Проверьте `docker-compose.yml` - переменные должны быть в `environment`

## Безопасность

### ✅ DO (Делать):
- Используйте сильные случайные ключи
- Храните JWT_SECRET только в GitHub Secrets
- Регулярно ротируйте ключи (каждые 6-12 месяцев)
- Используйте HTTPS в продакшн
- Используйте разные ключи для dev/staging/production

### ❌ DON'T (Не делать):
- НЕ коммитьте JWT_SECRET в Git
- НЕ используйте примеры из документации
- НЕ делитесь секретом публично
- НЕ используйте короткие или предсказуемые ключи
- НЕ храните в переменных окружения локально (используйте .env файл в .gitignore)

## Дополнительная информация

Для более подробной информации см.:
- **AUTH_SETUP.md** - Документация по системе авторизации
- **DEPLOYMENT.md** - Общая документация по деплойменту
- **.env.example** - Пример конфигурации для локальной разработки
