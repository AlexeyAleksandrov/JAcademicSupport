# Health Check Timeout Fix

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–î–µ–ø–ª–æ–π –ø–∞–¥–∞–ª —Å –æ—à–∏–±–∫–æ–π:
```
‚ùå ERROR: Application did not become healthy within 60s
‚ùå Rollback also failed - manual intervention required
```

**–ü—Ä–∏—á–∏–Ω–∞:** Spring Boot —Å 15 JPA —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏ + Hibernate –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–Ω–∏–º–∞–µ—Ç ~60-90 —Å–µ–∫—É–Ω–¥ –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω–æ–º VPS, –Ω–æ timeout –±—ã–ª –≤—Å–µ–≥–æ 60 —Å–µ–∫—É–Ω–¥.

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ß—Ç–æ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ:

1. **deploy.sh** - –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ VPS:
   - üÜï –ü–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π (–Ω–µ—Ç backup): **600 —Å–µ–∫—É–Ω–¥ (10 –º–∏–Ω—É—Ç)**
   - üÜï –û–±—ã—á–Ω—ã–π –¥–µ–ø–ª–æ–π (–µ—Å—Ç—å backup): **420 —Å–µ–∫—É–Ω–¥ (7 –º–∏–Ω—É—Ç)**
   - üÜï –û—Ç–∫–∞—Ç: **300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç)**
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è backup –ø–µ—Ä–µ–¥ –ø–æ–ø—ã—Ç–∫–æ–π –æ—Ç–∫–∞—Ç–∞
   - ‚úÖ –ë–æ–ª—å—à–µ –ª–æ–≥–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ (100 —Å—Ç—Ä–æ–∫ –≤–º–µ—Å—Ç–æ 50)

2. **docker-compose.yml** - –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã healthcheck –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ VPS:
   ```yaml
   retries: 54         # 540 —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–≤–µ—Ä–æ–∫ (9 –º–∏–Ω—É—Ç)
   start_period: 120s  # 2 –º–∏–Ω—É—Ç—ã grace period
   # –ò—Ç–æ–≥–æ: –¥–æ 11 –º–∏–Ω—É—Ç –Ω–∞ –∑–∞–ø—É—Å–∫
   ```

3. **scripts/health-check.sh** - –£–ª—É—á—à–µ–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ + –¥–µ—Ç–µ–∫—Ü–∏—è –∫—Ä–∞—à–∞:
   - üÜï **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –∫—Ä–∞—à–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞** (exit code != 0)
   - üÜï –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∞—à–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
   - üÜï –ü–æ–∫–∞–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (JPA, Hibernate, Tomcat)
   - üÜï Default timeout: 600 —Å–µ–∫—É–Ω–¥ (10 –º–∏–Ω—É—Ç)
   - üÜï –ü–æ–ª—É—á–µ–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ (–±—ã–ª–æ 50)
   - ‚úÖ –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω—ã–π VPS
   - ‚úÖ –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –≤—ã–≤–æ–¥ —Å –º–∏–Ω—É—Ç–∞–º–∏

4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
   - `DEPLOYMENT_TIMEOUTS.md` - –ø–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–∞–π–º–∞—É—Ç–∞–º
   - `TIMEOUT_FIX.md` - —ç—Ç–æ —Ä–µ–∑—é–º–µ

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: –î–µ—Ç–µ–∫—Ü–∏—è –∫—Ä–∞—à–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –†–∞–Ω—å—à–µ –µ—Å–ª–∏ Spring –∫—Ä–∞—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π, —Å–∫—Ä–∏–ø—Ç –∂–¥–∞–ª –≤–µ—Å—å timeout.

**–†–µ—à–µ–Ω–∏–µ:** –¢–µ–ø–µ—Ä—å –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:
- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ –µ—â–µ –∑–∞–ø—É—â–µ–Ω?
- Exit code –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–µ—Å–ª–∏ —É–ø–∞–ª)
- –ï—Å–ª–∏ exit code != 0 ‚Üí **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π fail –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è**

**–ü—Ä–∏–º–µ—Ä:**
```bash
‚è≥ Waiting for application to start... (10s elapsed)
‚ùå CRITICAL: Container crashed with exit code 1

=== Crash Logs (last 100 lines) ===
Error: Unable to access jarfile /app/app.jar
```

## üöÄ –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å

### –®–∞–≥ 1: –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```bash
git add .
git commit -m "fix: increase timeouts for slow VPS and add crash detection

- Increase first deploy timeout to 600s (10 min)
- Increase normal deploy timeout to 420s (7 min)
- Increase rollback timeout to 300s (5 min)
- Add immediate container crash detection (exit code)
- Check for crashes every 5 seconds
- Show initialization progress with minutes
- Increase docker healthcheck to 54 retries (9 min + 2 min grace)

Optimized for slow VPS with average startup time 80-90s"
git push origin master
```

### –®–∞–≥ 2: –ù–∞–±–ª—é–¥–∞—Ç—å –∑–∞ –¥–µ–ø–ª–æ–µ–º

–¢–µ–ø–µ—Ä—å –≤—ã —É–≤–∏–¥–∏—Ç–µ:
```
8. Performing health check...
‚ö†Ô∏è  First deployment detected - using extended timeout (600s / 10 minutes)
‚è±Ô∏è  Health check timeout: 600s (10 minutes)

=== Health Check Started ===
Max wait time: 600s (10 minutes)
‚ö†Ô∏è  Note: Running on slow VPS - startup may take up to 5-7 minutes

‚è≥ Waiting for application to start... (10s elapsed)
üìã Initializing JPA repositories...
‚è≥ Waiting for application to start... (20s elapsed)
üìã Connecting to database...
‚è≥ Still waiting... (120s / 600s elapsed, ~2m)
üìã JPA initialization complete...
‚è≥ Still waiting... (140s / 600s elapsed, ~2m)
üìã Starting Tomcat server...
‚úì Spring Boot application started (155s elapsed)

Verifying health endpoint...
‚úÖ SUCCESS: Application is healthy!

=== Health Check Summary ===
Total startup time: 160s (2m 40s)
Status: HEALTHY
```

**–ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫—Ä–∞—à–Ω–µ—Ç—Å—è:**
```
‚è≥ Waiting for application to start... (10s elapsed)
‚ùå CRITICAL: Container crashed with exit code 1

=== Container Status ===
Exited (1) 2 seconds ago

=== Crash Logs (last 100 lines) ===
[–ª–æ–≥–∏ –æ—à–∏–±–∫–∏]

‚ùå ERROR: Health check failed!
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

| –°—Ü–µ–Ω–∞—Ä–∏–π | –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è | –¢–∞–π–º–∞—É—Ç | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|----------|---------------|---------|-----------|
| –ü–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π (–º–µ–¥–ª–µ–Ω–Ω—ã–π VPS) | 80-150s | 600s ‚úÖ | –£—Å–ø–µ—Ö |
| –û–±—ã—á–Ω—ã–π –¥–µ–ø–ª–æ–π | 60-100s | 420s ‚úÖ | –£—Å–ø–µ—Ö |
| –û—Ç–∫–∞—Ç | 40-80s | 300s ‚úÖ | –£—Å–ø–µ—Ö |
| –ö—Ä–∞—à –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ | - | 5-10s ‚úÖ | –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π fail |

## üéØ –ü–æ—á–µ–º—É —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ

1. **–ù–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤—Ä–µ–º—è —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è** - –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç –∑–∞ 90s, –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –∑–∞ 90s
2. **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å** - –ø–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π (—Å–∞–º—ã–π –º–µ–¥–ª–µ–Ω–Ω—ã–π) –ø–æ–ª—É—á–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π timeout
3. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π fail –ø—Ä–∏ –∫—Ä–∞—à–∞—Ö** - –Ω–µ –∂–¥–µ—Ç timeout –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–ø–∞–ª
4. **–í–∏–¥–∏–º–æ—Å—Ç—å** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏ —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Å—Ç–∞–ª–æ—Å—å
5. **–ú–µ–Ω—å—à–µ false positives** - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ VPS

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä healthy
docker ps
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: backend ... Up X minutes (healthy)

# 2. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞
docker logs backend | grep "Started.*Application"
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å < 420 —Å–µ–∫—É–Ω–¥ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health endpoint
curl http://your-server:8080/actuator/health
# –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: {"status":"UP"}
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- **–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏**: —Å–º. `DEPLOYMENT_TIMEOUTS.md`
- **Health check –Ω–∞—Å—Ç—Ä–æ–π–∫–∞**: —Å–º. `HEALTH_CHECK_SETUP.md`
- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–µ–ø–ª–æ—è**: —Å–º. `DEPLOYMENT_OPTIMIZATION.md`

## ‚ö° –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –º–µ–¥–ª–µ–Ω–Ω–æ

–ï—Å–ª–∏ –¥–∞–∂–µ 10 –º–∏–Ω—É—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ (–æ—á–µ–Ω—å –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ):

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã VPS**:
   ```bash
   docker stats backend
   free -h
   ```

2. **–£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã** –≤ `deploy.sh`:
   ```bash
   HEALTH_CHECK_TIMEOUT=900  # 15 –º–∏–Ω—É—Ç –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –¥–µ–ø–ª–æ—è
   ```

3. **–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ VPS** (RAM, CPU)

4. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å Spring Boot** (—Å–º. DEPLOYMENT_TIMEOUTS.md):
   - Lazy initialization
   - Disable JMX
   - Optimize JPA

---

**–ì–æ—Ç–æ–≤–æ!** –ó–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏ –∑–∞–ø—É—à—å—Ç–µ - –¥–µ–ø–ª–æ–π –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏ —É—Å–ø–µ—à–Ω–æ –¥–∞–∂–µ –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω–æ–º VPS, —Å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –¥–µ—Ç–µ–∫—Ü–∏–µ–π –∫—Ä–∞—à–µ–π! üöÄ
